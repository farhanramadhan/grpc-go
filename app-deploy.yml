apiVersion: apps/v1
kind: Deployment
metadata:
  name: grpc-${IMAGE_NAME}
  namespace: merchant
  labels:
    app: grpc-${IMAGE_NAME}
    squad: komunitas-pintar
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grpc-${IMAGE_NAME}
  template:
    metadata:
      labels:
        app: grpc-${IMAGE_NAME}
    spec:
      terminationGracePeriodSeconds: 30
      nodeSelector:
        warpin: services
      containers:
        - image: asia.gcr.io/warung-support/${IMAGE_NAME}:${IMAGE_VERSION}
          name: grpc-${IMAGE_NAME}
          imagePullPolicy: Always
          env:
            - name: FOR_GODS_SAKE_PLEASE_REDEPLOY
              value: 'THIS_STRING_IS_REPLACED_DURING_BUILD'
          ports:
            - containerPort: 8081
          readinessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:8081"]
            initialDelaySeconds: 5
          livenessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:8081"]
            initialDelaySeconds: 10
          args: ["grpc"]
      imagePullSecrets:
        - name: gcr-json-key

---
apiVersion: v1
kind: Service
metadata:
  name: grpc-${IMAGE_NAME}
  namespace: merchant
  labels:
    app: grpc-${IMAGE_NAME}
spec:
  type: NodePort
  ports:
    - name: grpc-${IMAGE_NAME}
      port: 50055
      targetPort: 8081
      protocol: TCP
  selector:
    app: grpc-${IMAGE_NAME}

---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: grpc-${IMAGE_NAME}
  namespace: istio-system
spec:
  hosts:
    - onepiece-staging.warungpintar.co
  gateways:
    - staging-gateway.istio-system.svc.cluster.local
  http:
    - match:
        - uri:
            prefix: "/farhan-onboard/"
      route:
        - destination:
            host: grpc-${IMAGE_NAME}.merchant.svc.cluster.local
            port:
              number: 50055
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: gateway-error,connect-failure,refused-stream
